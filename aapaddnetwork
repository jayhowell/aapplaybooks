---
- name: Ensure all VMs in namespace have cusa network and interface
  hosts: localhost
  gather_facts: no
  vars:
    vm_namespace: canon-test   # <--- change once

  tasks:
    - name: Get all VMs in the namespace
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachine
        namespace: "{{ vm_namespace }}"
      register: all_vms

    - name: Ensure cusa network/interface exist on each VM
      vars:
        vm_networks: "{{ item.spec.template.spec.networks | default([]) }}"
        vm_interfaces: "{{ item.spec.template.spec.domain.devices.interfaces | default([]) }}"
      loop: "{{ all_vms.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"
      block:
        - name: Patch VM to add cusa network
          when: "'cusa' not in [n.name for n in vm_networks]"
          kubernetes.core.k8s:
            api_version: kubevirt.io/v1
            kind: VirtualMachine
            name: "{{ item.metadata.name }}"
            namespace: "{{ vm_namespace }}"
            merge_type: strategic-merge
            definition:
              spec:
                template:
                  spec:
                    networks:
                      - name: cusa
                        multus:
                          networkName: cusa-canon

        - name: Patch VM to add cusa interface
          when: "'cusa' not in [i.name for i in vm_interfaces]"
          kubernetes.core.k8s:
            api_version: kubevirt.io/v1
            kind: VirtualMachine
            name: "{{ item.metadata.name }}"
            namespace: "{{ vm_namespace }}"
            merge_type: strategic-merge
            definition:
              spec:
                template:
                  spec:
                    domain:
                      devices:
                        interfaces:
                          - name: cusa
                            bridge: {}
